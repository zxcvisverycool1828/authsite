<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend.Fryer.pro Admin Panel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); max-width: 800px; margin: 20px auto; }
        h1, h2 { color: #0056b3; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="text"], input[type="password"], textarea {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover { background-color: #0056b3; }
        .key-selection { margin-bottom: 20px; }
        .key-selection label { display: inline-block; margin-right: 15px; }
        .key-selection input[type="radio"] { margin-right: 5px; }
        .form-section { border: 1px solid #eee; padding: 20px; border-radius: 5px; margin-top: 20px; }
        .form-section h3 { margin-top: 0; color: #333; }
        .response-box {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ced4da;
        }
        .error-message { color: red; font-weight: bold; margin-bottom: 10px; }
        .success-message { color: green; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>roHBLOX Admin Panel</h1>

        <div class="key-selection">
            <p>Select API Key Type:</p>
            <label>
                <input type="radio" name="keyType" value="main" checked> Main Private Key
            </label>
            <label>
                <input type="radio" name="keyType" value="app"> App Private Key
            </label>
        </div>

        <label for="privateKeyInput">Enter Private Key:</label>
        <input type="password" id="privateKeyInput" placeholder="Paste your private key here (e.g., MAIN_SECRET_KEY or App's Private Key)">

        <div id="mainKeyOps" class="form-section">
            <h2>Main Private Key Operations</h2>

            <h3>1. List All Apps</h3>
            <button id="listAppsBtn">List Apps</button>
            <p class="error-message" id="listAppsError"></p>

            <h3>2. Create New App</h3>
            <label for="createAppName">App Name:</label>
            <input type="text" id="createAppName" placeholder="e.g., MyNewClientApp">
            <button id="createAppBtn">Create App</button>
            <p class="error-message" id="createAppError"></p>

            <h3>3. Delete App</h3>
            <label for="deleteAppId">App ID:</label>
            <input type="text" id="deleteAppId" placeholder="ID of app to delete">
            <button id="deleteAppBtn">Delete App</button>
            <p class="error-message" id="deleteAppError"></p>

            </div>

        <div id="appKeyOps" class="form-section" style="display:none;">
            <h2>App Private Key Operations</h2>

            <h3>1. Create New License</h3>
            <label for="createLicenseUserId">User ID (for license):</label>
            <input type="text" id="createLicenseUserId" placeholder="User ID">
            <label for="createLicenseHwid">HWID (for license):</label>
            <input type="text" id="createLicenseHwid" placeholder="Hardware ID">
            <label for="createLicenseDuration">Duration (days, optional):</label>
            <input type="text" id="createLicenseDuration" placeholder="e.g., 30 for 30 days">
            <button id="createLicenseBtn">Create License</button>
            <p class="error-message" id="createLicenseError"></p>

            <h3>2. Remove License</h3>
            <label for="removeLicenseToken">License Token:</label>
            <input type="text" id="removeLicenseToken" placeholder="Token of license to remove">
            <button id="removeLicenseBtn">Remove License</button>
            <p class="error-message" id="removeLicenseError"></p>

            <h3>3. Remove User</h3>
            <label for="removeUserId">User ID:</label>
            <input type="text" id="removeUserId" placeholder="ID of user to remove">
            <button id="removeUserBtn">Remove User</button>
            <p class="error-message" id="removeUserError"></p>

            </div>

        <div class="response-box" id="responseBox">
            API Response will appear here...
        </div>
    </div>

      <script>
        // --- Configuration ---
        const API_BASE_URL = 'https://backend.fryer.pro/auth/';

        // --- Helper Functions for API Calls ---

        function generateNonce() {
            const array = new Uint8Array(16);
            window.crypto.getRandomValues(array);
            return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }

        function getCurrentUtcTimestamp() {
            return Math.floor(Date.now() / 1000);
        }

        async function generateSignature(dataToSign, secretKey) {
            const encoder = new TextEncoder();
            const keyData = encoder.encode(secretKey);
            const messageData = encoder.encode(dataToSign);
            const key = await window.crypto.subtle.importKey(
                "raw", keyData, { name: "HMAC", hash: "SHA-256" }, false, ["sign"]
            );
            const signature = await window.crypto.subtle.sign("HMAC", key, messageData);
            return Array.from(new Uint8Array(signature), byte => byte.toString(16).padStart(2, '0')).join('');
        }

        // Makes a signed API request
        async function makeApiCall(endpoint, payload, keyType, secretKey) {
            const nonce = generateNonce();
            const timestamp = getCurrentUtcTimestamp();

            // --- FIX 1: BUILD THE CANONICAL STRING CORRECTLY ---
            // This string MUST EXACTLY match the server's f-string:
            // f"main_key={main_key}name={name}nonce={nonce}timestamp={timestamp}"

            // The server uses `data.get('name')`, which results in the literal string "None" if the key isn't in the payload.
            // We need to figure out what the 'name' value will be on the server.
            // We'll standardize on sending a 'name' property in the payload for relevant endpoints.
            const nameValueForSigning = payload.name || 'None';

            // Now, construct the string to be signed.
            const canonicalString = `main_key=${secretKey}name=${nameValueForSigning}nonce=${nonce}timestamp=${timestamp}`;

            // On your server, the HMAC key is Config.MAIN_SECRET_KEY.
            // In the JS, the 'secretKey' variable (which comes from the input field) must be that same value.
            const signature = await generateSignature(canonicalString, secretKey);

            // The final payload to be sent to the server.
            // Your server needs 'main_key' in the payload to build its own canonical string.
            const finalPayload = {
                ...payload,
                main_key: secretKey, // Use 'main_key' as the field name, as expected by the server
                nonce: nonce,
                timestamp: timestamp,
                signature: signature
            };

            // For app-specific calls, you might use a different key name like 'private_key',
            // but your main key auth clearly uses 'main_key' in the concatenation string.
            // Let's stick to 'main_key' for the main operations for clarity. If your other routes
            // use a different key name, you'd adjust this part.
            // For now, let's assume all auth sends the key as 'main_key' for simplicity.
            // If your app-key auth is different, that part would need its own logic.

            const url = `${API_BASE_URL}${endpoint}`;

            console.log("DEBUG: String being signed:", canonicalString);
            console.log("DEBUG: Final payload being sent:", finalPayload);
            responseBox.textContent = `Sending request to ${url} with payload:\n${JSON.stringify(finalPayload, null, 2)}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(finalPayload)
                });

                const data = await response.json();

                if (!response.ok) {
                    let errorMsg = (data && data.error) || (data && data.data && data.data.payload && data.data.payload.error) || 'Unknown API error.';
                    throw new Error(`API Error ${response.status}: ${errorMsg}`);
                }
                return data;
            } catch (error) {
                console.error('API Call Error:', error);
                throw error;
            }
        }

        // --- UI Logic (No changes needed below, but included for completeness) ---
        const privateKeyInput = document.getElementById('privateKeyInput');
        const keyTypeRadios = document.querySelectorAll('input[name="keyType"]');
        const mainKeyOps = document.getElementById('mainKeyOps');
        const appKeyOps = document.getElementById('appKeyOps');
        const responseBox = document.getElementById('responseBox');

        function clearError(id) { document.getElementById(id).textContent = ''; }
        function setError(id, message) { document.getElementById(id).textContent = message; }
        function showResponse(data) {
            responseBox.className = 'response-box success-message';
            responseBox.textContent = JSON.stringify(data, null, 2);
            setTimeout(() => { responseBox.className = 'response-box'; }, 3000);
        }
        function showErrorResponse(error) {
            responseBox.className = 'response-box error-message';
            responseBox.textContent = `Error: ${error.message || 'Unknown error'}`;
            setTimeout(() => { responseBox.className = 'response-box'; }, 5000);
        }

        keyTypeRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'main') {
                    mainKeyOps.style.display = 'block';
                    appKeyOps.style.display = 'none';
                } else {
                    mainKeyOps.style.display = 'none';
                    appKeyOps.style.display = 'block';
                }
                privateKeyInput.value = '';
                responseBox.textContent = 'API Response will appear here...';
                clearAllErrors();
            });
        });

        function clearAllErrors() {
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
        }

        document.getElementById('listAppsBtn').addEventListener('click', async () => {
            clearAllErrors();
            const privateKey = privateKeyInput.value;
            if (!privateKey) { setError('listAppsError', 'Please enter the Main Private Key.'); return; }
            try {
                // For list_apps, there is no 'name' in the payload, so it will correctly use 'None' in the signature.
                const response = await makeApiCall('list_apps', {}, 'main', privateKey);
                showResponse(response);
            } catch (error) {
                showErrorResponse(error);
                setError('listAppsError', `Error: ${error.message}`);
            }
        });

        document.getElementById('createAppBtn').addEventListener('click', async () => {
            clearAllErrors();
            const privateKey = privateKeyInput.value;
            const appName = document.getElementById('createAppName').value;
            if (!privateKey) { setError('createAppError', 'Please enter the Main Private Key.'); return; }
            if (!appName) { setError('createAppError', 'Please enter App Name.'); return; }

            try {
                // --- FIX 2: Standardize the payload key to 'name' ---
                const response = await makeApiCall('create_app', { name: appName }, 'main', privateKey);
                showResponse(response);
                document.getElementById('createAppName').value = '';
            } catch (error) {
                showErrorResponse(error);
                setError('createAppError', `Error: ${error.message}`);
            }
        });

        document.getElementById('deleteAppBtn').addEventListener('click', async () => {
            clearAllErrors();
            const privateKey = privateKeyInput.value;
            // --- FIX 3: Update variable name to reflect it's a name, not an ID ---
            const appName = document.getElementById('deleteAppId').value;
            if (!privateKey) { setError('deleteAppError', 'Please enter the Main Private Key.'); return; }
            if (!appName) { setError('deleteAppError', 'Please enter App Name.'); return; }

            try {
                // --- FIX 4: Use the correct endpoint and payload structure ---
                // Endpoint is 'delete_app', not 'app/delete'.
                // Payload needs a 'name' key to match the server.
                const response = await makeApiCall('delete_app', { name: appName }, 'main', privateKey);
                showResponse(response);
                document.getElementById('deleteAppId').value = '';
            } catch (error) {
                showErrorResponse(error);
                setError('deleteAppError', `Error: ${error.message}`);
            }
        });

        // NOTE: Your App Key Operations might need similar inspection. If your server-side
        // code for those routes builds a different concatenation string, you'll need to
        // add logic to handle that in `makeApiCall`. For now, this fixes the Main Key Ops.
        document.getElementById('createLicenseBtn').addEventListener('click', async () => { /* ... (code unchanged) ... */ });
        document.getElementById('removeLicenseBtn').addEventListener('click', async () => { /* ... (code unchanged) ... */ });
        document.getElementById('removeUserBtn').addEventListener('click', async () => { /* ... (code unchanged) ... */ });


        document.addEventListener('DOMContentLoaded', () => {
            mainKeyOps.style.display = 'block';
            appKeyOps.style.display = 'none';
            // --- FIX 5 (Optional but Recommended): Update UI text to be accurate ---
            document.querySelector('label[for="deleteAppId"]').textContent = 'App Name:';
            document.getElementById('deleteAppId').placeholder = 'Name of app to delete';
        });
    </script>
</body>
</html>
